<div class="container-fluid">

  <body class=" backgrountab">



    <div class="container-fluid ps-0 mt-4">
      <div class="custom-tabs">
        <!-- All Users -->
        <button class="custom-tab" [ngClass]="{ 'active': activeTab === 'All Users' }"
          (click)="setActiveTab('All Users')">
          All Users
          <span class="custom-badge" *ngIf="activeTab === 'All Users'">{{ users.length }}</span>
        </button>

        <!-- Host -->
        <button class="custom-tab" [ngClass]="{ 'active': activeTab === 'Host' }" (click)="setActiveTab('Host')">
          Host
          <span class="custom-badge" *ngIf="activeTab === 'Host'">{{ hostCount }}</span>
        </button>

        <!-- Guest -->
        <button class="custom-tab" [ngClass]="{ 'active': activeTab === 'Guest' }" (click)="setActiveTab('Guest')">
          Guest
          <span class="custom-badge" *ngIf="activeTab === 'Guest'">{{ guestCount }}</span>
        </button>

        <!-- Application Review -->
        <button class="custom-tab" [ngClass]="{ 'active': activeTab === 'Application Review' }"
          (click)="setActiveTab('Application Review')">
          Application Review
          <span class="custom-badge" *ngIf="activeTab === 'Application Review'">{{ hostApplications.length }}</span>
        </button>
      </div>

    </div>

  </body>

  <div class="col-11 main-table card">
    <div class="table-bar border-bottom d-flex justify-content-between align-items-center px-3 py-1">
      <h5 class="mb-0">{{ activeTab }}</h5>

      <div class="table-controls d-flex align-items-center gap-2">
        <!-- Search box -->
        <div class="position-relative w-100" style="max-width: 400px; margin: auto;">
          <div class="search-wrapper d-flex  position-relative">
            <img class="table-img me-3 mt-1" src="/img/searchicon.png" alt="Search" width="14" height="14" />
            <input class="input-search subfoont" type="text" placeholder="Search by name or email id" />
          </div>
        </div>

        <!-- Dropdown filter -->
        <div class="dropdown">
          <button class="btn dropdown-toggle custom-btn fontfamily" type="button" data-bs-toggle="dropdown">
            {{ currentFilter }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end heading-dropdown fontfamily">
            <li><a class="dropdown-item" (click)="applyFilter('All')">All</a></li>
            <li><a class="dropdown-item" (click)="applyFilter('Active')">Active</a></li>
            <li><a class="dropdown-item" (click)="applyFilter('Inactive')">Inactive</a></li>
          </ul>
        </div>
      </div>
    </div>


    <!-- Table -->
    <div class="table-responsive custom-scroll-table"
      [ngClass]="{'application-review-table': activeTab === 'Application Review'}">
      <table class="table align-middle mb-0 border-1px custom-table">

        <!-- Table Head -->
        <thead class="custom-head">
          <tr>
            <!-- Default columns -->
            <ng-container *ngIf="activeTab !== 'Application Review'">
              <th scope="col">User</th>
              <th scope="col">Role</th>
              <th scope="col">Status</th>
              <th scope="col">Join Date</th>
              <th scope="col">Action</th>
            </ng-container>

            <!-- Application Review columns -->
            <ng-container *ngIf="activeTab === 'Application Review'">
              <th scope="col" class="text-start">User</th>
              <th scope="col" class="text-end">Application Date</th>
              <th scope="col" class="text-end">Action</th>
            </ng-container>

          </tr>
        </thead>

        <!-- Table Body -->
        <tbody>

          <!-- Default User Rows -->
          <ng-container *ngIf="activeTab !== 'Application Review'">
            <tr *ngFor="let user of filteredUsers">
              <td>
                <div class="d-flex align-items-center gap-2">
                  <img [src]="user.img || '/img/ProfileimgIcon.png'" class="rounded-circle" width="40" height="40" />
                  <div>
                    <div class="fontfamily">{{ user.name }}</div>
                    <div class="subfoont">{{ user.email }}</div>
                  </div>
                </div>
              </td>
              <td class="role">
                <ng-container [ngSwitch]="user.role">
                  <img *ngSwitchCase="'Host'" src="/img/food.png" class="me-1 role" />
                  <img *ngSwitchCase="'Guest'" src="/dashboard/blueuser.png" class="me-1 role" />
                  <img *ngSwitchDefault src="/dashboard/defaulticon.png" class="me-1 role" />
                </ng-container>
                {{ user.role }}
              </td>

              <td>
                <span class="status-badge" [ngClass]="{
              'active': user.status === 'Active',
              'inactive': user.status === 'Inactive'
            }">
                  <span class="dot"></span> {{ user.status }}
                </span>
              </td>
              <td>{{ user.joinDate }}</td>
              <td>
                <div class="dropdown dropstart">
                  <button class="btn three-dot-btn pb-1  text-muted fs-4" type="button" data-bs-toggle="dropdown"><img
                      src="/img/Dots.png" alt=""></button>
                  <ul class="dropdown-menu shadow rounded-4 border-0 p-1 custom-dropdown">
                    <li>
                      <a class="dropdown-item fontfamily" data-bs-toggle="offcanvas" href="#hostDetails"
                        (click)="openOffcanvas(user, 'view')">View details</a>
                    </li>
                    <li>
                      <a class="dropdown-item fontfamily" data-bs-toggle="offcanvas" href="#hostDetails"
                        (click)="openOffcanvas(user, 'edit')">Edit</a>
                    </li>
                    <li>
                      <a class="dropdown-item text-danger fontfamily" href="#">Deactivate</a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>

            <!-- Empty row for default users -->
            <tr *ngIf="filteredUsers.length === 0">
              <td colspan="5" class="text-center py-3">No data available</td>
            </tr>
          </ng-container>



          <ng-container *ngIf="activeTab === 'Application Review'">
            <tr *ngFor="let user of hostApplications">
              <!-- User column -->
              <td class="user-col">
                <div class="d-flex align-items-center gap-2">
                  <img [src]="user.img" class="rounded-circle" width="40" height="40" />
                  <div class="user-info">
                    <div class="user-name fontfamily">{{ user.name }}</div>
                    <div class="user-email subfoont">{{ user.email }}</div>
                  </div>
                </div>
              </td>

              <!-- Application Date -->
              <td class="text-end application-date fontfamily">{{ user.joinDate }}</td>

              <!-- Action -->
              <td class="text-end action-col">
                <div class="d-flex justify-content-end gap-2">
                  <!-- Eye icon opens offcanvas in VIEW mode -->
                  <img src="/img/eyeicon.png" alt="View" width="24" height="24"
                    style="cursor:pointer; margin-right:15px;" (click)="openOffcanvas(user, 'view')"
                    data-bs-toggle="offcanvas" data-bs-target="#hostDetails" />
                </div>
              </td>
            </tr>

            <!-- Empty row if no hosts -->
            <tr *ngIf="hostApplications.length === 0">
              <td colspan="3" class="text-center py-3">No data available</td>
            </tr>
          </ng-container>


        </tbody>
      </table>
    </div>

  </div>



  <!-- Offcanvas -->
  <div class="offcanvas offcanvas-end host-offcanvas" tabindex="-1" id="hostDetails" aria-labelledby="hostDetailsLabel"
    (hidden.bs.offcanvas)="isMealDetailsView = false">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title d-flex align-items-center" id="hostDetailsLabel">
        <!-- Show back button only in Rejection -->
        <ng-container *ngIf="offcanvasTab === 'applicationReview' && appReviewSubTab === 'rejection'">
          <img src="/meal/backbtn.png" alt="Back" class="back-btn me-2" (click)="setAppReviewSubTab('overview')" />
        </ng-container>

        {{ getOffcanvasTitle() }}
      </h5>


      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"
        (click)="allClosed()"></button>
    </div>

    <div class="offcanvas-body" [ngClass]="getOffcanvasBodyClass()">

      <!-- Tabs -->
      <div class="container-fluid ps-0 mt-2 border-bottom-dotted" *ngIf="!isMealDetailsView">
        <div class="custom-tabs2">

          <!-- View Mode Tabs -->
          <ng-container *ngIf="mode === 'view' && offcanvasTab !== 'applicationReview'">
            <button class="custom-tab2 active">Overview</button>
            <button class="custom-tab2">Booking History</button>
          </ng-container>

          <!-- Edit Mode Tabs -->
          <ng-container *ngIf="mode === 'edit' || offcanvasTab === 'applicationReview'">

            <!-- Overview tab: always visible -->
            <button class="custom-tab2" [class.active]="
          (offcanvasTab === 'overview') || 
          (offcanvasTab === 'applicationReview' && appReviewSubTab === 'overview')
        " (click)="
          offcanvasTab === 'applicationReview' ? setAppReviewSubTab('overview') : setOffcanvasTab('overview')
        ">
              Overview
            </button>


            <!-- Upload Documents tab: only for Application Review -->
            <button *ngIf="offcanvasTab === 'applicationReview'" class="custom-tab2"
              [class.active]="appReviewSubTab === 'documents'" (click)="setAppReviewSubTab('documents')">
              Upload Documents
            </button>

            <!-- Listed Meals and Booking History: hide for Application Review -->
            <button *ngIf="offcanvasTab !== 'applicationReview'" class="custom-tab2"
              [class.active]="offcanvasTab === 'listedMeals'" (click)="setOffcanvasTab('listedMeals')">
              Listed Meals
            </button>

            <button *ngIf="offcanvasTab !== 'applicationReview'" class="custom-tab2"
              [class.active]="offcanvasTab === 'bookingHistory'" (click)="setOffcanvasTab('bookingHistory')">
              Booking History
            </button>

          </ng-container>

        </div>
      </div>


      <!-- User Header -->
      <!-- ✅ Show header only in overview -->
      <div *ngIf="offcanvasTab === 'overview'"
        class="user-header d-flex align-items-center mt-2 mb-2 border-bottom-dotted ">
        <img src="/img/ProfileimgIcon.png" class="rounded-circle me-3" alt="User">
        <div>
          <h6 class="mb-0 fw-semibold">{{ selectedUser?.name }}</h6>
          <small class="text-muted">{{ selectedUser?.email }}</small>
        </div>
        <span class="status-badge active ms-auto offstatus">
          <span class="dot"></span>{{ selectedUser?.status }}
        </span>
      </div>


      <!-- User Details -->
      <!-- User Details (only when NOT in Application Review) -->
      <div *ngIf="(mode === 'view' || offcanvasTab === 'overview') && offcanvasTab !== 'applicationReview'">

        <!-- User Details -->
        <div class="details-list">
          <!-- User Type -->
          <div class="detail-row user-type">
            <span class="label">User type</span>
            <span class="value">
              <!-- Show Host -->
              <span *ngIf="selectedUser?.role === 'Host'" class="host-badge">
                <img src="/img/food.png" alt="" style="margin-right:0.5rem; width:18px;">
                Host
              </span>

              <!-- Show Guest -->
              <span *ngIf="selectedUser?.role === 'Guest'" class="guest-badge">
                <img src="/dashboard/blueuser.png" alt="" style="margin-bottom: 4px; width:11px;">
                Guest
              </span>
            </span>
          </div>


          <!-- First Name -->
          <div class="detail-row">
            <span class="label">First name</span>
            <span class="value">
              <!-- View mode -->
              <span *ngIf="mode === 'view'">{{ selectedUser?.firstName }}</span>

              <!-- Edit mode -->
              <div *ngIf="mode === 'edit'">
                <!-- If not editing yet: just show the pen -->
                <div *ngIf="!isFirstNameEditing" class="d-flex align-items-center">
                  <span>{{ selectedUser?.firstName }}</span>
                  <img src="/img/redpen.png" alt="edit" style="width:24px;height:22px;cursor:pointer;margin-left:10px;"
                    (click)="toggleFirstNameEdit()" />
                </div>

                <!-- If editing: show input -->
                <div *ngIf="isFirstNameEditing" class="input-with-icon d-flex align-items-center">
                  <input type="text" [(ngModel)]="selectedUser!.firstName"
                    class="form-control form-control-sm red-border me-2" placeholder="Enter first name" />
                </div>
              </div>
            </span>
          </div>


          <!-- Last Name -->
          <div class="detail-row">
            <span class="label">Last name</span>
            <span class="value">
              <!-- View mode -->
              <span *ngIf="mode === 'view'">{{ selectedUser?.lastName }}</span>

              <!-- Edit mode -->
              <div *ngIf="mode === 'edit'">
                <!-- If not editing yet -->
                <div *ngIf="!isLastNameEditing" class="d-flex align-items-center">
                  <span>{{ selectedUser?.lastName }}</span>
                  <img src="/img/redpen.png" alt="edit"
                    style="width:24px;height:22px;cursor:pointer;margin-left:10px; padding-bottom: .3;"
                    (click)="toggleLastNameEdit()" />
                </div>

                <!-- If editing -->
                <div *ngIf="isLastNameEditing" class="d-flex align-items-center">
                  <input type="text" [(ngModel)]="selectedUser!.lastName"
                    class="form-control form-control-sm me-2 red-border" placeholder="Enter last name" />
                </div>
              </div>
            </span>
          </div>


          <!-- Display Name -->
          <div class="detail-row">
            <span class="label">Display name</span>
            <span class="value">
              <!-- Always read-only, no input in edit mode -->
              <span>{{ selectedUser?.displayName }}</span>
            </span>
          </div>


          <!-- Gender -->
          <div class="detail-row">
            <span class="label">Gender</span>
            <span class="value">
              <!-- Always show as text, both in view & edit -->
              <span>{{ selectedUser?.gender }}</span>
            </span>
          </div>


          <!-- Email -->
          <div class="detail-row">
            <span class="label">Email</span>
            <span class="value">{{ selectedUser?.email }}</span>
          </div>

          <!-- Contact -->
          <div class="detail-row">
            <span class="label">Contact</span>
            <span class="value">{{ selectedUser?.contact }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Country</span>
            <span class="value">{{ selectedUser?.country }}</span>
          </div>


          <div class="detail-row">
            <span class="label">Known languages</span>
            <span class="value">
              <span *ngFor="let lang of selectedUser?.knownLanguages" class="badge bg-dark me-1">{{ lang }}</span>
            </span>
          </div>
        </div>

        <div *ngIf="mode === 'edit' && (isFirstNameEditing || isLastNameEditing)" class="review-actions mt-3">
          <button class="reject-btn" (click)="discardChanges()">Discard changes</button>
          <button class="save-approve-btn" (click)="saveUserDetails()">Save changes</button>
        </div>




      </div>

      <div *ngIf="offcanvasTab === 'listedMeals' && !isMealDetailsView" class="mt-3">

        <div class="meal-item d-flex align-items-center mb-3 p-2 border meal-list">
          <!-- Meal Image -->
          <img src="/meal/meal1.png" alt="Meal"
            style="width:83px; height:83px; object-fit:cover; border-radius:8px; margin-right:10px;">

          <!-- Dish Info (Left side: Title + Subtext) -->
          <div class="flex-grow-1">
            <h6 class="mb-2 fw-semibold">Paneer Butter Masal</h6>
            <small class="text-muted">Dine-in • Tomorrow, Dinner</small>
            <div class="mt-1">
              <span class="status-badge active meal-size">Active</span>
            </div>
          </div>

          <!-- Right side: Button + Price -->
          <div class="d-flex flex-column align-items-end ms-3">
            <button class="btn custom-meal-btn" (click)="openMealDetails()">
              <img src="/meal/mealicon.png" alt=""> View Details
            </button>
            <div class="mb-0 meal-price1"><span class="meal-price1">₹250</span>
              <p class="meal-price">Per guest</p>
            </div>

          </div>
        </div>



      </div>


      <!-- Meal Details Page -->
      <div *ngIf="isMealDetailsView" class="container">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="card meal-card">
              <div class="card-header bg-dark text-white mealhead">
                <h6 class="mb-0">John Doe</h6>
              </div>
              <div class="card-body">
                <img src="/meal/meal2.png" class="img-fluid mealfull" alt="Sample Image">
              </div>
            </div>
          </div>
        </div>
        <div class="meal-info container mt-3">
          <div class="meal-info-row">
            <span class="meal-label mealfont">Meal Name</span>
            <span class="meal-value">Paneer Butter Masala with Naan and Jeera Rice</span>
          </div>

          <div class="meal-info-row">
            <span class="meal-label mealfont">Meal Type</span>
            <span class="meal-value">Dine-in, Take-Away, Delivery</span>
          </div>

          <div class="meal-info-row">
            <span class="meal-label mealfont">Scheduled Time</span>
            <span class="meal-value">Tomorrow, Dinner</span>
          </div>

          <div class="meal-info-row">
            <span class="meal-label mealfont">Price Per Guest</span>
            <span class="meal-value">₹ 280</span>
          </div>

          <div class="meal-info-row border-bottom pb-2 mb-2">
            <span class="meal-label mealfont">Meal Description</span>
            <span class="meal-value ">
              Rich paneer butter masala served with freshly made naan and fragrant jeera rice.
              Perfect for lunch with family or friends.
            </span>
          </div>

        </div>


      </div>

      <!-- ✅ Application Review  -->

      <!-- ================= OVERVIEW ================= -->
      <div *ngIf="offcanvasTab === 'applicationReview' && appReviewSubTab === 'overview'"
        class="app-review-overview-body">

        <div class="user-image">
          <img class="mt-3" src="/img/userimg.png" alt="User Image" style="width: 128px; height: 128px;">
        </div>

        <div class="user-details">
          <div class="detail-row">
            <span class="label">First name</span>
            <span class="value">{{ selectedUser?.firstName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Last name</span>
            <span class="value">{{ selectedUser?.lastName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Gender</span>
            <span class="value">{{ selectedUser?.gender }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Lorem</span>
            <span class="value">Lorem Ipsum</span>
          </div>
          <div class="detail-row">
            <span class="label">Lorem</span>
            <span class="value">Lorem Ipsum</span>
          </div>
          <div class="detail-row">
            <span class="label">Lorem</span>
            <span class="value">Lorem Ipsum</span>
          </div>
        </div>

        <!-- Buttons -->
        <div class="review-actions">
          <button class="reject-btn" (click)="setAppReviewSubTab('rejection')">Reject application</button>
          <button class="approve-btn">Approve application</button>
        </div>
      </div>


      <!-- ================= DOCUMENTS ================= -->
      <div *ngIf="offcanvasTab === 'applicationReview' && appReviewSubTab === 'documents'" class="documents-body">

        <!-- Aadhar Card -->
        <div class="doc-card" *ngIf="currentDoc === 1">
          <div class="doc-header"></div>
          <div class="doc-preview">
            <img src="/img/Adhar.png" alt="Aadhar Front" />
            <img src="/img/BackAdhar.png" alt="Aadhar Back" />
          </div>
          <div class="doc-footer">
            <span class="doc-index">Govt. ID&nbsp;&nbsp;1/2</span>
            <div class="nav-buttons">
              <div class="icon-btn" (click)="prevDoc()" [class.disabled]="currentDoc === 1">
                <img src="/sidebar/Preicon.png" alt="Previous">
              </div>
              <div class="icon-btn" (click)="nextDoc()">
                <img src="/sidebar/Next Icon.png" alt="Next">
              </div>
            </div>
          </div>
        </div>

        <!-- PAN Card -->
        <div class="doc-card" *ngIf="currentDoc === 2">
          <div class="doc-header"></div>
          <div class="doc-preview">
            <img src="/img/Adhar.png" alt="PAN Front" />
            <img src="/img/BackAdhar.png" alt="PAN Back" />
          </div>
          <div class="doc-footer">
            <span class="doc-index">FSSAI License&nbsp;&nbsp;2/2</span>
            <div class="nav-buttons">
              <div class="icon-btn" (click)="prevDoc()">
                <img src="/sidebar/Preicon.png" alt="Previous">
              </div>
              <div class="icon-btn" (click)="nextDoc()" [class.disabled]="currentDoc === 2">
                <img src="/sidebar/Next Icon.png" alt="Next">
              </div>
            </div>
          </div>
        </div>

        <!-- Approve / Reject buttons -->
        <div class="review-actions mt-3">
          <button class="reject-btn" (click)="setAppReviewSubTab('rejection')">Reject application</button>
          <button class="approve-btn">Approve application</button>
        </div>
      </div>


      <!-- ================= REJECTION ================= -->
      <div *ngIf="offcanvasTab === 'applicationReview' && appReviewSubTab === 'rejection'" class="rejection-body p-3">

        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <button class="btn btn-link p-0 me-2" (click)="setAppReviewSubTab('overview')">
              <i class="bi bi-arrow-left"></i>
            </button>
          </div>
          <button class="btn btn-link p-0" (click)="setAppReviewSubTab('overview')">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- Subheading -->
        <p class="fw-medium mb-3">Select issue for application rejection :</p>

        <!-- Section 1 -->
        <div class="mb-3">
          <h6 class="fw-semibold">1. Identity & Document Issues :</h6>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="expiredDoc">
            <label class="form-check-label" for="expiredDoc">
              National ID/Passport/License is expired
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="blurryDocs">
            <label class="form-check-label" for="blurryDocs">
              Uploaded documents are blurry or unreadable
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="mismatch">
            <label class="form-check-label" for="mismatch">
              Mismatch between profile details and document (e.g. name, photo, country)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="invalidType">
            <label class="form-check-label" for="invalidType">
              Document is not an accepted type (e.g. not a government-issued ID)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="tampering">
            <label class="form-check-label" for="tampering">
              Forgery or suspected tampering of document
            </label>
          </div>
        </div>

        <!-- Section 2 -->
        <div class="mb-3">
          <h6 class="fw-semibold">2. Incomplete or Invalid Application Information :</h6>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="badPhoto">
            <label class="form-check-label" for="badPhoto">
              Profile photo does not meet standards (e.g. not clear, headshot, professional)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="invalidContact">
            <label class="form-check-label" for="invalidContact">
              Provided email or phone number is invalid or unreachable
            </label>
          </div>
        </div>

        <!-- Section 3 -->
        <div class="mb-3">
          <h6 class="fw-semibold">3. Policy Violations or Platform Integrity Concerns</h6>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="duplicateAccount">
            <label class="form-check-label" for="duplicateAccount">
              User has a duplicate account
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="termsViolation">
            <label class="form-check-label" for="termsViolation">
              Terms of use violation discovered during the review
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="refusal">
            <label class="form-check-label" for="refusal">
              Refusal to comply with platform's background check process
            </label>
          </div>
        </div>

        <!-- Reason textarea -->
        <div class="mb-4">
          <label for="rejectionReason" class="fw-semibold">Rejection reason (optional)</label>
          <textarea id="rejectionReason" class="form-control mt-1" rows="3" maxlength="300"
            placeholder="Enter reason for application rejection..."></textarea>
          <small class="text-muted d-block text-end mt-1">
            <span id="charCount">0</span>/300
          </small>
        </div>

        <!-- Footer Button -->
        <div class="d-grid">
          <button class="btn btn-lg fw-semibold" style="background-color: #F04438; color: #fff; border: none;">
            Reject this application
          </button>
        </div>

      </div>






    </div>